package edu.lclark.orego.experiment;

import java.util.Scanner;
import java.io.*;

import edu.lclark.orego.core.StoneColor;

/**
 * Listens to a GTP player running in another process. Whenever that player
 * emits a line of output, the line is passed to an instance of Game.
 */
final class PlayerListener implements Runnable {

	/** The color of moves being generated by the other program. */
	private StoneColor color;

	/** Input from the other program. */
	private InputStream fromProgram;

	/** The Game being played. */
	private Game game;

	public PlayerListener(StoneColor color, InputStream input, Game game) {
		this.color = color;
		this.fromProgram = input;
		this.game = game;
	}

	@Override
	public void run() {
		try (Scanner s = new Scanner(fromProgram)) {
			boolean finishedNormally = false;
			while (s.hasNextLine()) {
				// s is passed in in case there is a multi-line error message,
				// so game can dump all of the message to the output file
				String line = s.nextLine();
				if (!line.isEmpty()) {
					finishedNormally = game.handleResponse(color, line, s);
				}
			}
			if (!finishedNormally) {
				game.handleResponse(color, "? program crashed", s);
			}
		}
	}

}
